var utils = require("users/aazuspan/geeSharpening:utils");

// Calculate bias, which measures similartiy between images. Values near 0 are good. Vaiopoulos 2011.
exports.calculate = function (
  referenceImage,
  assessmentImage,
  perBand,
  geometry,
  scale,
  maxPixels
) {
  // Default to returning image average
  if (utils.isMissing(perBand)) {
    perBand = false;
  }

  // if (utils.isMissing(geometry)) {
  //   geometry = referenceImage;
  // }

  // if (utils.isMissing(scale)) {
  //   scale = null
  // }

  if (utils.isMissing(maxPixels)) {
    maxPixels = 1e12;
  }

  var xbar = ee.Array(
    referenceImage
      .reduceRegion({
        reducer: ee.Reducer.mean(),
        geometry: geometry,
        scale: scale,
        maxPixels: maxPixels,
      })
      .values()
  );
  var ybar = ee.Array(
    assessmentImage
      .reduceRegion({
        reducer: ee.Reducer.mean(),
        geometry: geometry,
        scale: scale,
        maxPixels: maxPixels,
      })
      .values()
  );

  var bias = ybar.divide(xbar).multiply(-1).add(1).toList();

  // If not per band, average all bands
  if (perBand === false) {
    bias = ee.Number(bias.reduce(ee.Reducer.mean()));
  }

  return bias;
};
